<div class="month-timeline-container">
  <div class="timeline-header">
    <h2>–í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –ø–ª–∞–Ω–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h2>

    <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –¥–∞—Ç -->
    <div class="filters" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <label style="font-size:12px; color:#8c8c8c;">–ü–µ—Ä–∏–æ–¥:</label>

      <input type="date" [(ngModel)]="dateStartModel" />
      <span>‚Äî</span>
      <input type="date" [(ngModel)]="dateEndModel" />

      <button class="btn" (click)="applyDateFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button class="btn" (click)="clearDateFilter()" style="background:#f0f0f0; color:#262626;">–°–±—Ä–æ—Å</button>

      <div style="width:1px; height:20px; background:#f0f0f0; margin:0 4px;"></div>

      <button class="btn" (click)="presetThisYear()" style="background:#e6f4ff; color:#1890ff;">–¢–µ–∫—É—â–∏–π –≥–æ–¥</button>
      <button class="btn" (click)="presetLast6Months()" style="background:#fffbe6; color:#faad14;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 6
        –º–µ—Å.</button>

      <div class="timeline-info" style="margin-left:8px;">
        {{ timelineTasks.length }} –∑–∞–¥–∞—á, {{ timelineDowntimes.length }} –ø—Ä–æ—Å—Ç–æ–µ–≤
      </div>
    </div>
  </div>

  <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ç–∫—É –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –µ—Å—Ç—å –∑–∞–¥–∞—á–∏ -->
  <div *ngIf="hasPlanData; else noPlan" class="timeline-grid" [style.--months]="timelineMonths.length">
    <!-- –®–∞–ø–∫–∞ —Å –º–µ—Å—è—Ü–∞–º–∏ -->
    <div class="timeline-months-header" [style.--months]="timelineMonths.length">
      <div class="line-header-cell">–õ–∏–Ω–∏—è / –ü—Ä–æ–¥—É–∫—Ç</div>
      <div *ngFor="let month of timelineMonths" class="month-cell header-month" [title]="month.name + ' ' + month.year">
        {{ month.shortName }}
        <span class="year-badge" *ngIf="month.month === 1">{{ month.year }}</span>
      </div>
    </div>

    <!-- –°—Ç—Ä–æ–∫–∏: –∫–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å–≤–æ–µ–π –ª–∏–Ω–∏–∏ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ -->
    <div *ngFor="let row of productRows" class="timeline-row" [style.--months]="timelineMonths.length">
      <div class="line-name-cell" [title]="row.line + ' ‚Äî ' + row.product">
        <div style="display:flex; flex-direction:column; gap:2px;">
          <span style="font-weight:600;">{{ row.line }}</span>
          <span style="font-size:12px; color:#8c8c8c;">{{ row.product }}</span>
        </div>
      </div>

      <!-- –Ø—á–µ–π–∫–∏ –º–µ—Å—è—Ü–µ–≤ -->
      <div *ngFor="let month of timelineMonths" class="month-cell" [attr.data-month]="month.month"
        [attr.data-year]="month.year">
        <!-- –ó–∞–¥–∞—á–∏ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ (line+product) -->
        <div *ngFor="let task of getTasksForRow(row)" class="task-bar" [ngClass]="getTaskClassForMonth(task, month)"
          [ngStyle]="getTaskStyleForMonth(task, month)" [title]="'–ó–∞–¥–∞—á–∞: ' + task.title + ' (' + task.product + ')'">
          <span *ngIf="task.startMonth === month.month && task.startYear === month.year" class="task-label">
            {{ task.id }}
          </span>
        </div>

        <!-- –ü—Ä–æ—Å—Ç–æ–∏ –ª–∏–Ω–∏–∏ (–æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å—Ç—Ä–æ–∫–∏) -->
        <div *ngFor="let downtime of getDowntimesForLine(row.line)" class="downtime-overlay"
          [ngClass]="getDowntimeClassForMonth(downtime, month)"
          [title]="'–ü—Ä–æ—Å—Ç–æ–π: ' + downtime.kind + ' (' + downtime.status + ')'"></div>
      </div>
    </div>
  </div>

  <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
  <ng-template #noPlan>
    <div class="timeline-empty">
      <div class="empty-icon">üìä</div>
      <h3>–ù–µ—Ç –ø–ª–∞–Ω–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ</h3>
      <p>–ò–∑–º–µ–Ω–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–∞–Ω, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é —à–∫–∞–ª—É –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º –ª–∏–Ω–∏–∏.</p>
    </div>
  </ng-template>

  <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
  <div class="timeline-legend">
    <div class="legend-section">
      <h4>–ó–∞–¥–∞—á–∏ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º:</h4>
      <div class="legend-items">
        <div class="legend-item">
          <div class="legend-color task-jan-apr"></div>
          <span>–Ø–Ω–≤–∞—Ä—å - –ê–ø—Ä–µ–ª—å</span>
        </div>
        <div class="legend-item">
          <div class="legend-color task-may-jul"></div>
          <span>–ú–∞–π - –ò—é–ª—å</span>
        </div>
        <div class="legend-item">
          <div class="legend-color task-aug-dec"></div>
          <span>–ê–≤–≥—É—Å—Ç - –î–µ–∫–∞–±—Ä—å</span>
        </div>
      </div>
    </div>

    <div class="legend-section">
      <h4>–ü—Ä–æ—Å—Ç–æ–∏:</h4>
      <div class="legend-items">
        <div class="legend-item">
          <div class="legend-color downtime-pattern"></div>
          <span>–ü—Ä–æ—Å—Ç–æ–π –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</span>
        </div>
        <div class="legend-item">
          <div class="legend-color conflict-pattern"></div>
          <span>–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–æ—Å—Ç–æ—è</span>
        </div>
      </div>
    </div>
  </div>
</div>